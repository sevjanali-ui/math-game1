<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Математика с Жестове</title>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; background: #f0f8ff; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 800px; height: 600px; background: #000; border: 10px solid #ff9800; border-radius: 40px; overflow: hidden; }
        #webcam-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 75%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #math-problem { position: relative; z-index: 10; background: rgba(255, 255, 255, 0.95); color: #00a2ff; text-align: center; padding: 10px 30px; margin: 15px auto; border-radius: 20px; font-size: 42px; font-weight: 700; border: 4px solid #00a2ff; width: fit-content; }
        .options-container { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; z-index: 10; }
        .option-box { width: 150px; height: 150px; background: #ff9800; color: white; display: flex; justify-content: center; align-items: center; font-size: 60px; border-radius: 35px; border: 6px solid white; box-shadow: 0 8px 0 #e68a00; transition: 0.2s; }
        .active { transform: scale(1.15); background: #00c853; border-color: #fff; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="math-problem">Зареждане...</div>
    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline></video>
    </div>
    <div class="options-container">
        <div id="opt-left" class="option-box">?</div>
        <div id="opt-right" class="option-box">?</div>
    </div>
</div>

<!-- TensorFlow.js Библиотеки -->
<script src="https://cdn.jsdelivr.net"></script>
<script src="https://cdn.jsdelivr.net"></script>
<script src="https://cdn.jsdelivr.net"></script>

<script>
    const video = document.getElementById('webcam');
    const probEl = document.getElementById('math-problem');
    const optL = document.getElementById('opt-left');
    const optR = document.getElementById('opt-right');
    let currentProblem = {};
    let detector;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.frequency.setValueAtTime(523, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(784, audioCtx.currentTime + 0.2);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
        }
        osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    }

    function generateProblem() {
        const a = Math.floor(Math.random() * 11);
        const b = Math.floor(Math.random() * 10);
        const res = a + b;
        const wrong = res + (Math.random() > 0.5 ? 2 : -2);
        const leftIsCorrect = Math.random() > 0.5;
        currentProblem = { q: `${a} + ${b} = ?`, correct: leftIsCorrect ? 0 : 1, ans: res };
        probEl.innerText = currentProblem.q;
        optL.innerText = leftIsCorrect ? res : wrong;
        optR.innerText = leftIsCorrect ? wrong : res;
    }

    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(res => video.onloadedmetadata = res);
    }

    async function main() {
        await setupCamera();
        detector = await handPoseDetection.createDetector(handPoseDetection.SupportedModels.MediaPipeHands, {
            runtime: 'mediapipe', solutionPath: 'https://cdn.jsdelivr.net'
        });
        generateProblem();
        detect();
    }

    let lastChoice = -1;
    let cooldown = false;

    async function detect() {
        const hands = await detector.estimateHands(video);
        let choice = -1;
        
        optL.classList.remove('active'); optR.classList.remove('active');

        if (hands.length > 0 && !cooldown) {
            const x = hands[0].keypoints[8].x; // Връх на показалеца
            if (x > 450) { choice = 0; optL.classList.add('active'); } // Огледално
            else if (x < 150) { choice = 1; optR.classList.add('active'); }

            if (choice !== -1) {
                if (choice === currentProblem.correct) {
                    playSound('correct');
                    cooldown = true;
                    setTimeout(() => { generateProblem(); cooldown = false; }, 1000);
                } else {
                    playSound('wrong');
                    cooldown = true;
                    setTimeout(() => { cooldown = false; }, 800);
                }
            }
        }
        requestAnimationFrame(detect);
    }

    main();
</script>
</body>
</html>
